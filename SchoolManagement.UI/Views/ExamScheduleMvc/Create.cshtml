@model SchoolManagement.Core.Entites.Models.ExamSchedule
@await Html.PartialAsync("_ExamDependencyInfo")

@{
    ViewData["Title"] = "Create Exam Schedule";
}
@Html.ValidationSummary(false, "", new { @class = "text-danger mb-3" })

<div class="container py-4">
    <h2 class="mb-4 text-primary fw-bold">
        <i class="bi bi-calendar-plus me-2"></i> @ViewData["Title"]
    </h2>

    <form asp-action="Create" method="post" class="needs-validation" novalidate>
        <div class="row g-4">
            <!-- Exam Dropdown -->
            <div class="col-md-4 position-relative">
                <label for="examSearchInput" class="form-label">Exam</label>

                <!-- Search input -->
                <input type="text" id="examSearchInput" class="form-control mb-1" placeholder="Search Exams..." autocomplete="off" />

                <!-- Visible select (not hidden anymore) -->
                <select asp-for="ExamId" class="form-select" asp-items="ViewBag.ExamList" id="ExamId">
                    <option value="">-- Select Exam --</option>
                </select>

                <ul id="examResults" class="list-group position-absolute w-100" style="z-index: 1000; max-height: 200px; overflow-y: auto; display: none;"></ul>

                <span asp-validation-for="ExamId" class="text-danger small"></span>
            </div>

            <!-- Class Dropdown -->
            <div class="col-md-4">
                <label asp-for="ClassId" class="form-label">Class</label>
                <select asp-for="ClassId" class="form-select" asp-items="ViewBag.ClassList" id="ClassId">
                    <option value="">-- Select Class --</option>
                </select>
                <span asp-validation-for="ClassId" class="text-danger small"></span>
            </div>

            <!-- Subject Dropdown -->
            <div class="col-md-4">
                <label asp-for="SubjectId" class="form-label">Subject</label>
                <select asp-for="SubjectId" class="form-select" id="SubjectId">
                    <option value="">-- Select Subject --</option>
                </select>
                <div id="subjectLoading" class="form-text text-muted" style="display: none;">
                    <i class="bi bi-arrow-repeat me-1"></i> Loading subjects...
                </div>
                <span asp-validation-for="SubjectId" class="text-danger small"></span>
            </div>

            <!-- Exam Date -->
            <div class="col-md-4">
                <label asp-for="ExamDate" class="form-label">Exam Date</label>
                <input asp-for="ExamDate" type="date" class="form-control" />
                <span asp-validation-for="ExamDate" class="text-danger small"></span>
            </div>

            <!-- Start Time -->
            <div class="col-md-4">
                <label asp-for="StartTime" class="form-label">Start Time</label>
                <input asp-for="StartTime" type="time" class="form-control" />
                <span asp-validation-for="StartTime" class="text-danger small"></span>
            </div>

            <!-- End Time -->
            <div class="col-md-4">
                <label asp-for="EndTime" class="form-label">End Time</label>
                <input asp-for="EndTime" type="time" class="form-control" />
                <span asp-validation-for="EndTime" class="text-danger small"></span>
            </div>

            <!-- Room Number -->
            <div class="col-md-6">
                <label asp-for="RoomNumber" class="form-label">Room Number</label>
                <input asp-for="RoomNumber" class="form-control" placeholder="e.g., 101A" />
                <span asp-validation-for="RoomNumber" class="text-danger small"></span>
            </div>

            <!-- Action Buttons -->
            <div class="col-12 mt-2 d-flex justify-content-start">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-save me-1"></i> Create Schedule
                </button>
                <a asp-action="Index" class="btn btn-outline-secondary ms-2">
                    <i class="bi bi-arrow-left-circle me-1"></i> Cancel
                </a>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    @await Html.PartialAsync("_ValidationScriptsPartial")

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const input = document.getElementById('examSearchInput');
            const dropdownList = document.getElementById('examResults');
            const select = document.getElementById('ExamId');

            const allOptions = Array.from(select.options)
                .filter(opt => opt.value !== "")
                .map(opt => ({ text: opt.text, value: opt.value }));

            // When user types in search box
            input.addEventListener('input', function () {
                const keyword = this.value.toLowerCase();
                dropdownList.innerHTML = '';

                if (!keyword) {
                    dropdownList.style.display = 'none';
                    return;
                }

                const matches = allOptions.filter(opt => opt.text.toLowerCase().includes(keyword));

                if (matches.length === 0) {
                    dropdownList.innerHTML = '<li class="list-group-item text-muted">No matches found</li>';
                } else {
                    matches.forEach(opt => {
                        const li = document.createElement('li');
                        li.textContent = opt.text;
                        li.classList.add('list-group-item', 'list-group-item-action');
                        li.style.cursor = 'pointer';

                        li.onclick = () => {
                            input.value = opt.text;
                            select.value = opt.value;
                            select.dispatchEvent(new Event('change'));
                            dropdownList.style.display = 'none';
                        };

                        dropdownList.appendChild(li);
                    });
                }

                dropdownList.style.display = 'block';
            });

            // Hide search results when clicking outside
            document.addEventListener('click', function (e) {
                if (!dropdownList.contains(e.target) && e.target !== input) {
                    dropdownList.style.display = 'none';
                }
            });

            // When user manually selects from dropdown
            select.addEventListener('change', function () {
                const selected = this.options[this.selectedIndex];
                input.value = selected.text; // Sync to input
                loadSubjects(selected.value); // Trigger subject fetch
            });

            // Load subjects function
            function loadSubjects(examId) {
                const subjectSelect = document.getElementById('SubjectId');
                const loadingIndicator = document.getElementById('subjectLoading');

                subjectSelect.innerHTML = '<option value="">-- Select Subject --</option>';

                if (!examId) return;

                loadingIndicator.style.display = 'inline';
                subjectSelect.disabled = true;

                fetch(`/ExamScheduleMvc/GetSubjectsByExamId?examId=${examId}`)
                    .then(res => res.json())
                    .then(data => {
                        data.forEach(subject => {
                            const option = document.createElement('option');
                            option.value = subject.id;
                            option.text = subject.subjectName;
                            subjectSelect.appendChild(option);
                        });
                    })
                    .catch(() => alert("Failed to load subjects."))
                    .finally(() => {
                        loadingIndicator.style.display = 'none';
                        subjectSelect.disabled = false;
                    });
            }
        });
    </script>
}