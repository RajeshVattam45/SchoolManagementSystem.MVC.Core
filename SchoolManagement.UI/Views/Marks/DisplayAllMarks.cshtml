@model IEnumerable<SchoolManagement.Core.ViewModels.MarksDetailsDto>
@using System.Text.RegularExpressions

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

@if (ViewBag.Error != null)
{
    <div class="alert alert-danger">@ViewBag.Error</div>
}

@{
    var groupedByClass = Model
        .GroupBy(m => new { m.ClassId, m.ClassName, m.AcademicYear })
        .OrderBy(g =>
        {
            var match = Regex.Match(g.Key.ClassName, @"\d+");
            return match.Success ? int.Parse(match.Value) : int.MaxValue;
        }).ToList();
    int tabIndex = 0;
}

<div class="container mt-5 p-2">

    <!-- Search Form -->
    <form asp-action="SearchByStudent" method="get" class="row g-2 align-items-center mb-4">
        <div class="col-md-4">
            <div class="input-group">
                <span class="input-group-text bg-primary text-white"><i class="bi bi-search"></i></span>
                <input type="text" name="query" class="form-control" placeholder="Search by student name or ID" value="@ViewBag.Query" />
            </div>
        </div>
        <div class="col-auto">
            <button type="submit" class="btn btn-success"><i class="bi bi-funnel-fill"></i> Search</button>
            <a asp-action="DisplayAllMarks" class="btn btn-outline-secondary ms-2"><i class="bi bi-x-circle"></i> Reset</a>
        </div>
    </form>

    <!-- Class Tabs -->
    <ul class="nav nav-pills mb-4 overflow-auto flex-nowrap" id="classTabs" role="tablist">
        @foreach (var classGroup in groupedByClass)
        {
            var classId = $"class-tab-{tabIndex}";
            <li class="nav-item" role="presentation">
                <button class="nav-link @(tabIndex == 0 ? "active" : "")" id="@classId-tab" data-bs-toggle="tab" data-bs-target="#@classId" type="button" role="tab">
                    📘 @classGroup.Key.ClassName (@classGroup.Key.AcademicYear)
                </button>
            </li>
            tabIndex++;
        }
    </ul>

    <div class="tab-content" id="classTabsContent">
        @{
            tabIndex = 0;
        }
        @foreach (var classGroup in groupedByClass)
        {
            var classId = $"class-tab-{tabIndex}";
            var students = classGroup.GroupBy(m => m.StudentFullName).ToList();
            int studentIndex = 0;
            <div class="tab-pane fade @(tabIndex == 0 ? "show active" : "")" id="@classId" role="tabpanel">
                <div id="students-@classId">
                    @if (!students.Any())
                    {
                        <div class="alert alert-info text-center p-4">📭 No students available in this class.</div>
                    }
                    else
                    {
                        @foreach (var studentGroup in students)
                        {
                            var studentCardId = $"student-card-{classId}-{studentIndex}";
                            <div class="card mb-3 student-block">
                                <div class="card-header bg-primary text-white">
                                    <button class="btn btn-link text-white text-decoration-none w-100 text-start" data-bs-toggle="collapse" data-bs-target="#@studentCardId">
                                        👦 @studentGroup.Key
                                    </button>
                                </div>
                                <div id="@studentCardId" class="collapse">
                                    <div class="card-body">
                                        <div class="row">
                                            @foreach (var examTypeGroup in studentGroup.GroupBy(m => m.ExamTypeName))
                                            {
                                                var examTypeId = Regex.Replace(examTypeGroup.Key + studentCardId, "[^a-zA-Z0-9]", "");
                                                var totalMarks = examTypeGroup.Sum(m => m.MarksObtained);
                                                var totalMax = examTypeGroup.Sum(m => m.MaxMarks);
                                                var avgPercentage = totalMax > 0 ? (double)totalMarks / totalMax * 100 : 0;
                                                var hasFail = examTypeGroup.Any(m => ((double)m.MarksObtained / m.MaxMarks) * 100 < 35);
                                                var badgeClass = hasFail ? "bg-danger" : "bg-success";
                                                <div class="col-md-6 mb-3">
                                                    <div class="card">
                                                        <div class="card-header d-flex justify-content-between align-items-center">
                                                            <strong>@examTypeGroup.Key</strong>
                                                            <span class="badge @badgeClass">@(hasFail ? "Fail" : "Pass")</span>
                                                        </div>
                                                        <div class="card-body">
                                                            <p><strong>Percentage:</strong> @avgPercentage.ToString("F2")%</p>
                                                            <button class="btn btn-sm btn-outline-primary" data-bs-toggle="collapse" data-bs-target="#@examTypeId">
                                                                View Details
                                                            </button>
                                                            <div class="collapse mt-2" id="@examTypeId">
                                                                <table class="table table-sm table-bordered">
                                                                    <thead class="table-light">
                                                                        <tr>
                                                                            <th>Subject</th>
                                                                            <th>Exam</th>
                                                                            <th>Marks</th>
                                                                            <th>Max</th>
                                                                            <th>%</th>
                                                                            <th>Result</th>
                                                                            <th>Actions</th>
                                                                        </tr>
                                                                    </thead>
                                                                    <tbody>
                                                                        @foreach (var mark in examTypeGroup)
                                                                        {
                                                                            var percentage = (double)mark.MarksObtained / mark.MaxMarks * 100;
                                                                            var isPass = percentage >= 35;
                                                                            <tr class="@(isPass ? "" : "table-danger")">
                                                                                <td>@mark.SubjectName</td>
                                                                                <td>@mark.ExamName</td>
                                                                                <td>@mark.MarksObtained</td>
                                                                                <td>@mark.MaxMarks</td>
                                                                                <td>@percentage.ToString("F0")%</td>
                                                                                <td><span class="badge @(isPass ? "bg-success" : "bg-danger")">@(isPass ? "Pass" : "Fail")</span></td>
                                                                                <td>
                                                                                    <a href="@Url.Action("Edit", "Marks", new { id = mark.MarkId })" class="btn btn-sm btn-warning">Edit</a>
                                                                                    <a href="@Url.Action("Delete", "Marks", new { id = mark.MarkId })" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this mark?');">Delete</a>
                                                                                </td>
                                                                            </tr>
                                                                        }
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                            studentIndex++;
                        }
                    }
                </div>
            </div>
            tabIndex++;
        }
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    });
</script>
